# Prometheus Alert Rules for Quantum X Trading Platform
# Import into Prometheus via prometheus.yml: rule_files: ["alert-rules.yml"]

groups:
  - name: quantum-x-availability
    rules:
      # High error rate alert
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.05
        for: 2m
        labels:
          severity: critical
          service: quantum-x
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      # Service down alert
      - alert: ServiceDown
        expr: up{job="quantum-x"} == 0
        for: 1m
        labels:
          severity: critical
          service: quantum-x
        annotations:
          summary: "Quantum X service is down"
          description: "The Quantum X backend service has been unreachable for more than 1 minute"

      # No requests received (possible network issue)
      - alert: NoRequests
        expr: |
          sum(rate(http_requests_total[5m])) == 0
          and
          up{job="quantum-x"} == 1
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "No HTTP requests received"
          description: "Service is up but no requests received in the last 5 minutes"

  - name: quantum-x-performance
    rules:
      # High latency alert (P95 > 1 second)
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, sum(rate(http_request_duration_ms_bucket[5m])) by (le))
          > 1000
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "High API latency detected"
          description: "P95 latency is {{ $value | humanizeDuration }} over the last 5 minutes"

      # Very high latency (P99 > 5 seconds)
      - alert: VeryHighLatency
        expr: |
          histogram_quantile(0.99, sum(rate(http_request_duration_ms_bucket[5m])) by (le))
          > 5000
        for: 2m
        labels:
          severity: critical
          service: quantum-x
        annotations:
          summary: "Very high API latency detected"
          description: "P99 latency is {{ $value | humanizeDuration }} - service may be degraded"

      # High request rate (potential attack or traffic spike)
      - alert: HighRequestRate
        expr: sum(rate(http_requests_total[1m])) > 1000
        for: 2m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "High request rate detected"
          description: "Request rate is {{ $value | humanize }}/s - potential traffic spike"

      # Slow endpoint detected
      - alert: SlowEndpoint
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_ms_bucket[5m])) by (le, path)
          ) > 2000
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "Slow endpoint detected"
          description: "Endpoint {{ $labels.path }} has P95 latency of {{ $value | humanizeDuration }}"

  - name: quantum-x-websocket
    rules:
      # No WebSocket connections
      - alert: NoWebSocketConnections
        expr: websocket_connections == 0
        for: 10m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "No WebSocket connections"
          description: "No active WebSocket connections for 10 minutes"

      # WebSocket connection spike
      - alert: WebSocketConnectionSpike
        expr: |
          (websocket_connections - websocket_connections offset 5m)
          / websocket_connections offset 5m > 1
        for: 2m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "WebSocket connection spike"
          description: "WebSocket connections increased by {{ $value | humanizePercentage }} in 5 minutes"

      # High WebSocket message rate
      - alert: HighWebSocketMessageRate
        expr: sum(rate(websocket_messages_total[1m])) > 10000
        for: 2m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "High WebSocket message rate"
          description: "WebSocket message rate is {{ $value | humanize }}/s"

  - name: quantum-x-trading
    rules:
      # Backtest taking too long
      - alert: LongRunningBacktest
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_ms_bucket{path="/api/backtest/run"}[5m])) by (le)
          ) > 30000
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "Backtests running slowly"
          description: "P95 backtest duration is {{ $value | humanizeDuration }}"

      # High rate of 4xx errors (client errors)
      - alert: HighClientErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"4.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "High client error rate"
          description: "Client error rate is {{ $value | humanizePercentage }}"

  - name: quantum-x-infrastructure
    rules:
      # High requests in flight (potential bottleneck)
      - alert: HighRequestsInFlight
        expr: http_requests_in_flight > 100
        for: 2m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "High number of requests in flight"
          description: "{{ $value }} requests currently being processed"

      # Request queue growing (processing slower than incoming)
      - alert: RequestQueueGrowing
        expr: |
          rate(http_requests_in_flight[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: quantum-x
        annotations:
          summary: "Request queue is growing"
          description: "In-flight requests increasing at {{ $value | humanize }}/s"
